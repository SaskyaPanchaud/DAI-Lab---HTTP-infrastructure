# DAI Lab - HTTP Infrastructure

## Step 1 - Static Web site

File *nginx.conf* explained :
```
server {
    # This tells Nginx on which port he should expect connections.
    listen 80;

    # This defines the root of our static web site on the machine.
    root /contentStaticWebSite;

    # This defines a new location (in this case, it will be the homepage, i.e. when the URL is <mywebsiteaddress>/).
    location / {
        # This tells Nginx which file to display.
        index index.html;
    }
}
```

Commands to use for demo :
```
# to build image
docker build -t <imageName> ./staticWebSite
# to run container
docker run -it -d -p 8080:80 --name <containerName> <imageName>
```

## Step 2 - Docker compose

File *docker-compose.yml* explained :
```
version: '3.8'

services:

static-web-site:
    build: ./staticWebSite
    image: http/site
    ports:
        - "8081:80"
```

Commands to use for demo :
```
# to build the infrastructure
docker compose build
# to run the infrastructure
docker compose up
# to stop the infrastructure
docker compose down
```


## Step 3 - HTTP API server

It's a basic API which manages quotes (content and author).
There isn't a database, but a list of quotes is stored in the QuoteController class.
This class has the following methods to handle the requests : getOne, getAll, create, delete and update (these all take a Javalin Context as a parameter).


## Step 4 - Reverse proxy with Traefik

Configuration of *docker-compose.yml* :
```
version: '3.8'

# add network
networks:
    traefik:
        name: traefik

services:
    static-web-site:
        build: ./staticWebSite
        image: http/site
        # add route for Traefik
        labels:
           - traefik.http.routers.static-web-site.rule=Host("localhost")

    http-api-server:
        build: ./httpApiServer
        image: http/api
        # add route for Traefik
        labels:
            - traefik.http.routers.http-api-server.rule=Host("localhost") && PathPrefix("/api")

    # add reverse-proxy service
    reverse-proxy:
        image: traefik:v2.10
        # accee to dashboard
        command: --api.insecure=true --providers.docker
        ports:
            # api and static site web
            - "80:80"
            # dashboard
            - 8080:8080
        volumes:
            # access to container's list
            - /var/run/docker.sock:/var/run/docker.sock
```

Reverse proxy :
A reverse proxy is useful to improve the security of the infrastructure because all querys go on it and after the reverse proxy redirects to the internal servers.

Traefik Dashboard :
The Traefik dashboard is accessed on port 8080. It works because we add *command: --api.insecure=true --providers.docker* in docker-compose file.

## Step 5 - Scalability and load balancing

To start the infrastructure with several instances of each server (static and dynamic), we add this lines (in this case, there will be 2 instances) :
```
    deploy:
      replicas: 2
```
To do it dynamic, we have used this command :
```
# one service
docker compose up --scale <service>=<nb instance>
# several services
docker service scale <service>=<nb instance> <service>=<nb instance>
```
Logs show that Traefik performs load balancing among the instances (but for api ?).

## Step 6 - Load balancing with round-robin and sticky sessions

We add this line for the api service :
```
 - traefik.http.services.api.loadbalancer.sticky.cookie=true
```

To validate this step, we add *System.out.println("-- NEW REQUEST --");* in QuoteController.getAll() to see in the logs which instance is called.

## Step 7 - Securing Traefik with HTTPS

### Certificates

The certificates were generated by running the following command: 

```
openssl req  -nodes -new -x509  -keyout key.pem -out cert.pem
```

These are mounted to the traefik Docker container as a volume.

### Traefik config

This file defines simple HTTP and HTTPS entry points with the correct port.
We also specify the path to our certificates, the provider (Docker) and 
enable the dashboard. Some of this was previously done in our `docker-compose.yml` file.

This file is mounted to our traefik container as a volume. 

### Activating the entrypoints

This step was done in `docker-compose.yml`, where we added the following 
labels to both container's routers: 
```yaml
- traefik.http.routers.<router-name>.tls=true
- traefik.http.routers.<router-name>.entrypoints=https # Our HTTPS entrypoint is named https
```

We also had to change the following port forwarding to the traefik container: 
```yaml
- "443:443"
```

## Optional step 1: Management UI

We use *Portainer* to manage the containers of our infrastructure. We add this config to the docker-compose.yml :

```
# ajout de l'image portainer pour visualiser et gerer les ressources de Docker
agent:
image: portainer/agent
volumes:
- /var/run/docker.sock:/var/run/docker.sock
- /var/lib/docker/volumes:/var/lib/docker/volumes

portainer:
image: portainer/portainer-ce
command: -H tcp://agent:9001 --tlsskipverify
ports:
- "9000:9000"
volumes:
- /var/run/docker.sock:/var/run/docker.sock
- portainer_data:/data
depends_on:
- agent

volumes:
portainer_data:
```

To access to this, go on http://localhost:9000 and enter :
    
 - user : admin
 - password : heigcoursdailabo.